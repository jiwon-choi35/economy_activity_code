import pandas as pd
import pyreadstat
import statsmodels.formula.api as smf
import numpy as np
import os 
import matplotlib.pyplot as plt
import seaborn as sns

# ----------------------------------------------------
# --- 0. ì„¤ì •ê°’: íŒŒì¼ ê²½ë¡œ ë° í•µì‹¬ ë³€ìˆ˜ëª… ---
# ----------------------------------------------------
# â— 1. ì‹¤ì œ ë‹¤ìš´ë¡œë“œ ë°›ì€ 2020ë…„~2024ë…„ SAS íŒŒì¼ì˜ ê²½ë¡œ ë¦¬ìŠ¤íŠ¸ìž…ë‹ˆë‹¤. (ì‚¬ìš©ìž ì§€ì • ê²½ë¡œ)
# ì´ ê²½ë¡œì— íŒŒì¼ì´ ì¡´ìž¬í•´ì•¼ ë¶„ì„ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
file_paths = [
    "C:/Users/82108/Downloads/chs20_all_re/chs20_all_re.sas7bdat",
    "C:/Users/82108/Downloads/chs21_all/chs21_all.sas7bdat",
    "C:/Users/82108/Downloads/chs22_all/chs22_all.sas7bdat",
    "C:/Users/82108/Downloads/chs23_all/chs23_all.sas7bdat",
    "C:/Users/82108/Downloads/chs24_all/chs24_all.sas7bdat",
]

# 2. í™•ì •ëœ ë³€ìˆ˜ëª… ë° ë¶„ì„ ëŒ€ìƒ ì—°ë ¹
TARGET_AGE_MIN = 20
TARGET_AGE_MAX = 39 

VAR_AGE = 'age'                  # ì—°ë ¹ 
VAR_DEPRESSION = 'mtb_01z1'      # ì¢…ì† ë³€ìˆ˜: í˜„ìž¬ ìš°ìš¸ê° ê²½í—˜ ìœ ë¬´
VAR_SLEEP = 'mtc_10z1'           # ë…ë¦½ ë³€ìˆ˜: ì‹¤ì œë¡œ ìž ìž” ì‹œê°„(ì‹œ)
VAR_WEIGHT = 'wt_p'              # ê°œì¸ ê°€ì¤‘ì¹˜ 

# ðŸ’¥ ì¶”ê°€ëœ í†µì œ ë³€ìˆ˜ 3ê°€ì§€ ì„¤ì • ðŸ’¥
VAR_SEX = 'sex'                 # í†µì œ 1: ì„±ë³„ (1=ë‚¨, 2=ì—¬)
VAR_DIABETES = 'dia_04z1'       # í†µì œ 2: ë‹¹ë‡¨ë³‘ ìœ ë¬´ (1=ì˜ˆ, 2=ì•„ë‹ˆì˜¤)
VAR_HYPERTENSION = 'hya_04z1'   # í†µì œ 3: ê³ í˜ˆì•• ìœ ë¬´ (1=ì˜ˆ, 2=ì•„ë‹ˆì˜¤)


# ---------------------------------------------
# --- 1. SAS íŒŒì¼ ë¡œë“œ ë° í†µí•© (ë°˜ë³µë¬¸) ---
# ---------------------------------------------
all_data = []
print("--------------------------------------------------")
print("1. 2020ë…„ë¶€í„° 2024ë…„ê¹Œì§€ SAS íŒŒì¼ ë¡œë“œ ë° í†µí•© ì‹œë„...")

for file_path in file_paths:
    try:
        # íŒŒì¼ ë¡œë“œ ì‹œë„
        df_year, _ = pyreadstat.read_sas7bdat(file_path)
        
        # ì»¬ëŸ¼ëª…ì„ ëª¨ë‘ ì†Œë¬¸ìžë¡œ í†µì¼
        df_year.columns = df_year.columns.str.lower()
        
        # íŒŒì¼ ê²½ë¡œì—ì„œ ì—°ë„ ì •ë³´ ì¶”ì •í•˜ì—¬ ë°ì´í„°í”„ë ˆìž„ì— ì¶”ê°€
        file_name_part = os.path.basename(file_path).lower()
        year = 'N/A'
        if 'chs2' in file_name_part:
            try:
                start_index = file_name_part.find('chs') + 3
                year = int(file_name_part[start_index:start_index+2]) + 2000
            except:
                year = 'N/A'
        
        df_year['EXAMIN_YEAR'] = year
        all_data.append(df_year)
        print(f"âœ… íŒŒì¼ ì½ê¸° ì„±ê³µ: {os.path.basename(file_path)} (ì‘ë‹µìž ìˆ˜: {len(df_year)})")
    except FileNotFoundError:
        print(f"âŒ ì˜¤ë¥˜: íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”: {file_path}")
    except Exception as e:
        print(f"âŒ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ ({os.path.basename(file_path)}): {e}")
        
if not all_data:
    print("âŒ í†µí•©í•  ë°ì´í„°ê°€ ì—†ì–´ ë¶„ì„ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit()
    
# ëª¨ë“  ë°ì´í„°í”„ë ˆìž„ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ê¸°
df_combined = pd.concat(all_data, ignore_index=True)
print(f"âœ… ëª¨ë“  ë°ì´í„° í†µí•© ì™„ë£Œ! (ì´ ì‘ë‹µìž ìˆ˜: {len(df_combined)})")


# ---------------------------------------------
# --- 2. ë¶„ì„ ëŒ€ìƒ í•„í„°ë§ ë° ë°ì´í„° í´ë¦¬ë‹ ---
# ---------------------------------------------

# 2-1. ì²­ë…„ì¸µ (20-39ì„¸) ì¶”ì¶œ
df_youth = df_combined[(df_combined[VAR_AGE] >= TARGET_AGE_MIN) & (df_combined[VAR_AGE] <= TARGET_AGE_MAX)].copy()

# 2-2. í•„ìˆ˜ ë³€ìˆ˜ ê²°ì¸¡ì¹˜ ì œê±° (í†µì œ ë³€ìˆ˜ í¬í•¨)
# ìˆ˜ë©´ ì‹œê°„ ìœ íš¨ê°’(77 ë¯¸ë§Œ) ë° ëª¨ë“  í†µì œ ë³€ìˆ˜ì˜ ìœ íš¨ê°’(1 ë˜ëŠ” 2) í™•ì¸
df_analysis = df_youth[
    (df_youth[VAR_DEPRESSION].isin([1, 2])) & 
    (df_youth[VAR_SLEEP] < 77) &
    (df_youth[VAR_SEX].isin([1, 2])) &              
    (df_youth[VAR_DIABETES].isin([1, 2])) &        
    (df_youth[VAR_HYPERTENSION].isin([1, 2]))      
].copy()

# ---------------------------------------------
# --- 3. ë³€ìˆ˜ ë¦¬ì½”ë”© ë° ë³€í™˜ (ë¡œì§€ìŠ¤í‹± íšŒê·€ ì¤€ë¹„) ---
# ---------------------------------------------

# 3-1. ì¢…ì† ë³€ìˆ˜ ë° ë…ë¦½ ë³€ìˆ˜ ë¦¬ì½”ë”©
df_analysis['depressed'] = df_analysis[VAR_DEPRESSION].replace({2: 0, 1: 1}).astype(int)
df_analysis['sleep_hours'] = df_analysis[VAR_SLEEP].astype(float) 

# 3-2. ðŸ’¥ í†µì œ ë³€ìˆ˜ ë¦¬ì½”ë”© ðŸ’¥
df_analysis['male'] = df_analysis[VAR_SEX].replace({2: 0, 1: 1}).astype(int) # ì—¬ì„±(2)ì„ ê¸°ì¤€(0)ìœ¼ë¡œ
df_analysis['has_diabetes'] = df_analysis[VAR_DIABETES].replace({2: 0, 1: 1}).astype(int)
df_analysis['has_hypertension'] = df_analysis[VAR_HYPERTENSION].replace({2: 0, 1: 1}).astype(int)

# 3-3. ê°€ì¤‘ì¹˜ ë³€ìˆ˜ëª… ë‹¨ìˆœí™”
df_analysis = df_analysis.rename(columns={VAR_WEIGHT: 'WGT'}) 

print(f"\n2. ë°ì´í„° ì „ì²˜ë¦¬ ê²°ê³¼")
print(f"âœ… ìµœì¢… ë¶„ì„ ë°ì´í„° ì‘ë‹µìž ìˆ˜: {len(df_analysis)}ëª…")
print(f"   20-39ì„¸ ì²­ë…„ì¸µ ìš°ìš¸ê° ê²½í—˜ë¥ : {df_analysis['depressed'].mean() * 100:.2f}%")

# ---------------------------------------------
# --- 4. ë¡œì§€ìŠ¤í‹± íšŒê·€ ë¶„ì„ ì‹¤í–‰ ë° ê²°ê³¼ ì¶œë ¥ (ì£¼ì„ í•´ì œë¨) ---
# ---------------------------------------------

# ðŸ’¥ðŸ’¥ ëª¨ë¸ ê³µì‹: ìˆ˜ë©´ ì‹œê°„ + í†µì œ ë³€ìˆ˜ 3ê°€ì§€ ëª¨ë‘ í¬í•¨ ðŸ’¥ðŸ’¥
formula = (
    'depressed ~ sleep_hours + male + has_diabetes + has_hypertension'
) 

# ê°€ì¤‘ì¹˜(WGT)ë¥¼ ë°˜ì˜í•˜ì—¬ ëª¨ë¸ ì‹¤í–‰
model = smf.logit(formula=formula, data=df_analysis, weights=df_analysis['WGT']).fit()

print("\n--------------------------------------------------")
print("3. ðŸ“‰ ë‹¤ì¤‘ ë¡œì§€ìŠ¤í‹± íšŒê·€ ë¶„ì„ ìµœì¢… ê²°ê³¼ (ìˆ˜ë©´ ì‹œê°„ + í†µì œ ìš”ì¸)")
print("--------------------------------------------------")
print(model.summary().tables[1]) # íšŒê·€ ê³„ìˆ˜ í…Œì´ë¸” ì¶œë ¥

# ì˜¤ì¦ˆë¹„ (Odds Ratio) ê³„ì‚°
odds_ratios = np.exp(model.params)
conf_int = np.exp(model.conf_int())

print("\nâœ… ì˜¤ì¦ˆë¹„(Odds Ratio) ë° 95% ì‹ ë¢°êµ¬ê°„:")
odds_df = pd.DataFrame({'OR': odds_ratios, '2.5% CI': conf_int[0], '97.5% CI': conf_int[1]})
# ì ˆíŽ¸(Intercept) ì œì™¸ ë° ì£¼ìš” ë³€ìˆ˜ë§Œ ì¶œë ¥
print(odds_df[['OR', '2.5% CI', '97.5% CI']].iloc[1:]) 
print("--------------------------------------------------")
